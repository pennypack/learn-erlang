---
import { getCollection } from 'astro:content';
import ProgressTracker from './ProgressTracker.astro';

const posts = await getCollection('posts');
const sortedPosts = posts.sort((a, b) => a.data.postNumber - b.data.postNumber);

const currentPath = Astro.url.pathname;
---

<aside
  id="sidebar"
  class="fixed lg:relative inset-y-0 left-0 z-40 w-64 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out"
>
  <div class="p-4">
    <div class="mb-6">
      <ProgressTracker posts={sortedPosts} />
    </div>
    
    <nav class="space-y-1">
      <h2 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-3">
        Tutorial Posts
      </h2>
      
      {sortedPosts.map((post) => {
        const isActive = currentPath === `/posts/${post.slug}`;
        const isCompleted = false; // Will be updated with localStorage
        
        return (
          <a
            href={`/posts/${post.slug}`}
            class={`
              group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors
              ${isActive 
                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300' 
                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
              }
            `}
            data-post-number={post.data.postNumber}
          >
            <span class={`
              flex-shrink-0 w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center text-xs
              ${isActive 
                ? 'border-blue-500 bg-blue-500 text-white' 
                : 'border-gray-300 dark:border-gray-600'
              }
            `}>
              {isCompleted ? (
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              ) : (
                post.data.postNumber
              )}
            </span>
            
            <span class="truncate">{post.data.title}</span>
            
            <span class={`
              ml-auto text-xs px-2 py-0.5 rounded
              ${post.data.difficulty === 'beginner' && 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300'}
              ${post.data.difficulty === 'intermediate' && 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300'}
              ${post.data.difficulty === 'advanced' && 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300'}
            `}>
              {post.data.difficulty}
            </span>
          </a>
        );
      })}
    </nav>
    
    <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-800">
      <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-3">
        Resources
      </h3>
      <div class="space-y-2">
        <a href="/resources" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
          ğŸ“š Additional Resources
        </a>
        <a href="/cheatsheet" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
          ğŸ“ Erlang Cheatsheet
        </a>
        <a href="https://github.com/yourusername/learn-erlang/issues" target="_blank" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
          ğŸ› Report an Issue
        </a>
      </div>
    </div>
  </div>
</aside>

<script>
  // Update completion status based on localStorage
  function updateSidebarStatus() {
    const completedPosts = JSON.parse(localStorage.getItem('completedPosts') || '[]');
    
    document.querySelectorAll('[data-post-number]').forEach((link) => {
      const postNumber = parseInt(link.getAttribute('data-post-number') || '0');
      if (completedPosts.includes(postNumber)) {
        const numberSpan = link.querySelector('span:first-child');
        if (numberSpan && !link.classList.contains('bg-blue-100')) {
          numberSpan.classList.add('bg-green-500', 'text-white', 'border-green-500');
          numberSpan.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>';
        }
      }
    });
  }
  
  document.addEventListener('astro:page-load', updateSidebarStatus);
  document.addEventListener('astro:after-swap', updateSidebarStatus);
</script>